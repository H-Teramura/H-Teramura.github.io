---
title: "Z77チップセットなマシンでPCIパススルーに成功した話"
date: 2018-03-22 22:00 +0900
categories: [personal-computer, PC, IOMMU, pci-passthrough, Z77]
---
### あけましておめでとうございます
新年明けて色々していたら今日まで放置してしまっていた......。ともかく、今年もよろしくお願いします。実はこの前にも記事を書こうとしていたのですが[^1]、途中で頓挫したり他のことをやり始めたりして結局手についていませんでした。ここらへんの内容は、まあ、いつか書きます。多分。

### PCIパススルーができたぜ、という話
今日の本題はこれでして、家のメインPCでPCIパススルーができたことと設定方法などを書こうと思います。PCIパススルーの成功例は意外と貴重な情報らしいのでせっかくだから書いておこうということです。ちなみにここに書く情報は多分正確でないですし、私の運が良くて成功しただけかもしれませんからもしこの記事の内容を参考にされる場合は、私は参考にした結果について何も責任を負わないので注意してください（例によって）。あ、あともう一つ小さめの話題としてKMCの春合宿の話を最後にちょっとします。

### 構成（というか完成図みたいなもの）
ゴールはArch Linux上の仮想マシン（今回はWindows 10）でAMD Radeon RX 580とUSB3.0インターフェースカードを動かすことでした。これによってWindows仮想マシン側でグラフィックカードを利用するタイプのアプリ（ゲームとか画像編集ソフトとか）を比較的高速に動かすことができます。とりあえず下にハードウェア構成と使用しているOSを書こうと思います
#### ハードウェア
- CPU: Intel Core i7 3770
- RAM: 16GB DDR3
- M/B: ECS Z77H2-A3（BTOで頼んだら入っていたもの。BIOSを無理やりアップデートした）
- GPU（プライマリ）: 玄人志向 RH6450-LE1GB（同メーカーのPCIe-PCIブリッジでPCIスロットに接続）
- GPU（セカンダリ）: Intel HD Graphics 4000（CPU内蔵）
- GPU（パススルー用）: ASUS DUAL-RX580-O8G
- SSD0: Samsung 850 EVO 250GB
- SSD1: Intel SSD 530? 240GB
- HDD0: 1TB HDD

#### OS
- ホスト: Arch Linux x86_64（カーネルをダウングレードしている（後述））
- ゲスト: Windows 10 Pro x86_64

### 手順を話す前にいろいろ
#### CPUグラフィックスをプライマリ（起動用）にできない！
まずハマったところはここでした。説明書を見ていると起動用のグラフィックカードにCPU内蔵グラフィックスを使えそうだったのですが、いざ設定を開いてみるとなぜか"iGPU"が項目にないという事態。PCIeスロットにパススルーするグラフィックカードを挿していたのですがこれでは起動時にホスト側で使うように初期化されてしまいパススルーできませんでした。起動用に使うグラフィックカードはスロットの種類（PCIかPCIeか）でしか選べなかったのでPCIスロットになんとかして起動用のグラフィックカードを差すことにしました。

起動用のグラフィックカードとして試したものは2つで玄人志向からでているRH6450-LE1GBとPCIEX1-PCI（PCIスロットをブリッジを介してPCIex1に変換するもの）と、同メーカーのGF-GT610-LP1GHDです。前者はなんとか動きました。でも速度がかなり遅く[^2]、動作が不安定なのでGUIの出力はCPU内蔵グラフィックスに任せることにしました。後者はホストOSを起動することができませんでした。詳細は不明ですが解像度を変更するところで引っかかるようです。

[^1]:1,このサイトのソースをGitHubで見ると途中で投げられたページを見たりできる。
[^2]:2,実はマザーボード上でもPCIe<->PCI変換が行われており、大きく帯域を損しているものと思われる。Linuxの起動に成功したことも奇跡に近いのかもしれない。

#### パッケージのバージョン
今回の構成ではLinuxカーネルをダウングレードして運用しています（ハイパーバイザーも念の為ダウングレードしている）。というのも最近のバージョンだとUSBインターフェースカードをパススルー[^3]するとカーネルパニックが発生するためです。バージョンを控えるのを忘れたので後で書いておこうと思います。パッケージのバージョンが上がればまた動くようになるかもしれません。

[^3]:3,そもそもUSBインターフェースまでパススルーしなくてもいいじゃないか、USBパススルーを使えばいいじゃないかと言われるかもしれないが、USBパススルーだと一部のデバイス（ハブや光学ディスクドライブ）が正しく認識されないので個人的にはインターフェースそのものを仮想マシンに渡すほうが楽だと思っている。

### 手順
手順はほとんど[ArchWikiで紹介されているとおり](https://wiki.archlinux.jp/index.php/OVMF_%E3%81%AB%E3%82%88%E3%82%8B_PCI_%E3%83%91%E3%82%B9%E3%82%B9%E3%83%AB%E3%83%BC)です。しかし、少し工夫しないといけないところがあったのでそこだけ書いておきます。あ、ちなみにUSBインターフェースカードはvfio-pciでカーネルから分離する必要はないです。

#### パーミッションの設定
virt-managerの設定でファームウェアとしてUEFIが選べないときがあります。これはqemu.confにハイパーバイザーを実行するユーザとグループを適切に設定できておらずOVMFが見えないことが原因のようです。そこでユーザ"qemu"を作成してグループ"kvm"に追加してやります。そしてqemu.confの設定項目のところにそのユーザとグループを書いてやります（真ん中らへんに user= とか group= があるのでコメントアウトして等号の横に書く）。それからlibvirtdを再起動して仮想マシンを作成するとファームウェアにUEFIが選べるはずです。

こんな感じで（少なくとも私のマシンでは）PCIパススルーをできるようになりました。何か参考になればと思います。

### KMC春合宿
先日私の所属しているKMCの春合宿に行ってきました。そこでは部員同士で簡単な講座を開いていろいろなジャンルのことについて教え合いをします。プログラミングにおけるテクニックに関することや、研究の話、オーディオ製品の選び方など様々な話を聞くことができましたし、OB/OGの方々と交流ができ良い経験になりました。今回私も2つほど講座を担当させていただきました。その資料を下にのせておきましたのでもしよければご覧ください（変なこと言ってたらどうしよう）。

- [30分でできる！Linux超入門](https://www.kmc.gr.jp/~polaris/head-first-linux.pdf)
- [パソコンハードよもやま話](https://www.kmc.gr.jp/~polaris/random-telling-about-pc_cpy.pdf)

### おわりに
なんだかんだで全然記事を書いていなかったので本当に見てもらえているか心配ですがこれからはもう少し頻度をあげて書いていこうと思います。そのほうが日々の記録ができて自分のためにもなるような気がしますし。あとシンタックスハイライティングも早くできるようにしないといけませんね。

では、また。

*****
脚注
